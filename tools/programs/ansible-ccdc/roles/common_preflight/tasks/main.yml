---
# ============================================
# COMMON PRE-FLIGHT CHECKS
# ============================================

- name: Display pre-flight header
  ansible.builtin.debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "ðŸ›¡ï¸  Common Pre-Flight: {{ inventory_hostname }}"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

- name: Check Ansible version on control node
  ansible.builtin.assert:
    that:
      - ansible_version.major >= 2
      - ansible_version.minor >= 15
    fail_msg: "âŒ Ansible 2.15+ required (found {{ ansible_version.full }})"
    success_msg: "âœ… Ansible {{ ansible_version.full }}"
  delegate_to: localhost
  run_once: true


- name: Gather minimal facts if missing (required for OS detection)
  ansible.builtin.setup:
    gather_subset:
      - '!all'
      - 'min'
  when: ansible_os_family is not defined or ansible_distribution is not defined
  become: false

- name: Detect operating system family
  ansible.builtin.debug:
    msg: "OS Family: {{ ansible_os_family }}, Distribution: {{ ansible_distribution }}"

- name: Verify supported operating system
  ansible.builtin.assert:
    that:
      - ansible_os_family in ['Debian', 'RedHat']
    fail_msg: "âŒ Unsupported OS family: {{ ansible_os_family }}"
    success_msg: "âœ… Supported OS: {{ ansible_distribution }}"

- name: Ping check for competition reachability
  ansible.builtin.ping:
  register: ping_result

- name: Confirm sudo access for competition changes (whoami)
  ansible.builtin.command: whoami
  become: true
  changed_when: false
  register: sudo_test

- name: Verify sudo access
  ansible.builtin.assert:
    that:
      - sudo_test.rc == 0
      - sudo_test.stdout == 'root'
    fail_msg: "âŒ Sudo validation failed! (User: {{ ansible_user }}, Output: {{ sudo_test.stdout }})"
    success_msg: "âœ… Sudo access confirmed ({{ ansible_user }} -> root)"

- name: Display pre-flight summary
  ansible.builtin.debug:
    msg:
      - "âœ… Pre-flight checks passed for {{ inventory_hostname }}"
      - "   â€¢ OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
      - "   â€¢ Sudo: OK"
      - "   â€¢ Ready for competition hardening."
