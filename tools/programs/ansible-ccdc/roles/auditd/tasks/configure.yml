---
# ============================================
# AUDITD CONFIGURATION
# ============================================

- name: Backup existing audit rules
  ansible.builtin.shell: |
    if [ -f /etc/audit/rules.d/audit.rules ]; then
      cp /etc/audit/rules.d/audit.rules /etc/audit/rules.d/audit.rules.backup.{{ ansible_date_time.epoch }}
    fi
  args:
    creates: "/etc/audit/rules.d/audit.rules.backup.*"
  changed_when: false
  become: true

- name: Backup auditd.conf
  ansible.builtin.copy:
    src: "{{ auditd_config_file }}"
    dest: "{{ auditd_config_file }}.backup.{{ ansible_date_time.epoch }}"
    remote_src: true
    mode: '0640'
  changed_when: false
  become: true

- name: Deploy auditd.conf
  ansible.builtin.template:
    src: auditd.conf.j2
    dest: "{{ auditd_config_file }}"
    mode: '0640'
    owner: root
    group: root
    backup: true
  notify: restart auditd
  become: true

- name: Remove legacy audit.rules file if present
  ansible.builtin.file:
    path: /etc/audit/audit.rules
    state: absent
  become: true

- name: Deploy file integrity monitoring rules
  ansible.builtin.template:
    src: file_integrity.rules.j2
    dest: /etc/audit/rules.d/10-file-integrity.rules
    mode: '0640'
    owner: root
    group: root
  notify: reload auditd rules
  become: true

- name: Deploy privilege escalation monitoring rules
  ansible.builtin.template:
    src: privilege_escalation.rules.j2
    dest: /etc/audit/rules.d/20-privilege-escalation.rules
    mode: '0640'
    owner: root
    group: root
  notify: reload auditd rules
  become: true

- name: Deploy authentication monitoring rules
  ansible.builtin.template:
    src: authentication.rules.j2
    dest: /etc/audit/rules.d/30-authentication.rules
    mode: '0640'
    owner: root
    group: root
  notify: reload auditd rules
  become: true

- name: Deploy main audit rules
  ansible.builtin.template:
    src: audit.rules.j2
    dest: /etc/audit/rules.d/99-finalize.rules
    mode: '0640'
    owner: root
    group: root
  notify: reload auditd rules
  become: true

- name: Ensure auditd is enabled and started
  ansible.builtin.systemd:
    name: "{{ auditd_service_name }}"
    enabled: true
    state: started
  register: auditd_service
  become: true

- name: Display service status
  ansible.builtin.debug:
    msg: "{{ '✅ Auditd running' if auditd_service.status.ActiveState == 'active' else '⚠️  Auditd not active' }}"

- name: Flush handlers to reload rules
  ansible.builtin.meta: flush_handlers

- name: Wait for auditd to stabilize
  ansible.builtin.pause:
    seconds: 3

- name: Check loaded audit rules count
  ansible.builtin.shell: "auditctl -l | wc -l"
  register: rules_count
  changed_when: false
  become: true

- name: Display rules count
  ansible.builtin.debug:
    msg: "✅ Audit rules loaded: {{ rules_count.stdout }}"

- name: Ensure audit log rotation is configured
  ansible.builtin.copy:
    dest: /etc/logrotate.d/auditd
    content: |
      {{ auditd_log_file }} {
          missingok
          notifempty
          rotate {{ auditd_num_logs }}
          size {{ auditd_max_log_file }}M
          compress
          delaycompress
          postrotate
              /usr/bin/killall -HUP auditd
          endscript
      }
    mode: '0644'
    owner: root
    group: root
  become: true

- name: Display configuration summary
  ansible.builtin.debug:
    msg:
      - "Auditd configuration complete:"
      - "  • Config file: {{ auditd_config_file }}"
      - "  • Rules loaded: {{ rules_count.stdout }}"
      - "  • Log file: {{ auditd_log_file }}"
      - "  • Max log size: {{ auditd_max_log_file }} MB"
      - "  • Log retention: {{ auditd_num_logs }} files"
      - "  • Service: {{ 'ACTIVE' if auditd_service.status.ActiveState == 'active' else 'INACTIVE' }}"
