---
# fail2ban installation and configuration

- name: Import Debian fail2ban tasks
  ansible.builtin.import_tasks: _fail2ban_debian.yml
  when: ansible_os_family == "Debian"

- name: Import RedHat fail2ban tasks
  ansible.builtin.import_tasks: _fail2ban_redhat.yml
  when: ansible_os_family == "RedHat"

# --- Common tasks below ---

- name: Ensure fail2ban configuration directory exists
  ansible.builtin.file:
    path: /etc/fail2ban
    state: directory
    mode: '0755'
  become: true

- name: Deploy fail2ban jail configuration for SSH
  ansible.builtin.template:
    src: jail.local.j2
    dest: /etc/fail2ban/jail.local
    mode: '0644'
    backup: true
  notify: restart fail2ban
  become: true

- name: Ensure fail2ban is enabled and started
  ansible.builtin.systemd:
    name: fail2ban
    enabled: true
    state: started
  register: fail2ban_service
  become: true

- name: Display fail2ban service status
  ansible.builtin.debug:
    msg: "{{ '✅ fail2ban running' if fail2ban_service is success else '❌ fail2ban failed to start' }}"

- name: Check fail2ban status
  ansible.builtin.command: "fail2ban-client status sshd"
  register: fail2ban_status
  changed_when: false
  failed_when: false
  become: true

- name: Display fail2ban SSH jail status
  ansible.builtin.debug:
    msg: "{{ fail2ban_status.stdout_lines }}"
  when: fail2ban_status.rc == 0

- name: Display fail2ban summary
  ansible.builtin.debug:
    msg:
      - "Fail2ban configuration:"
      - "  • SSH jail: ENABLED"
      - "  • Ban time: {{ ssh_hardening_fail2ban_bantime }}s"
      - "  • Find time: {{ ssh_hardening_fail2ban_findtime }}s"
      - "  • Max retries: {{ ssh_hardening_fail2ban_maxretry }}"
      - ""
      - "ℹ️  Monitor fail2ban: fail2ban-client status sshd"
