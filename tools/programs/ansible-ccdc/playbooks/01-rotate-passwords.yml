---
# ============================================
# PASSWORD ROTATION PLAYBOOK
# ============================================
# Purpose: Rotate OS account passwords from initial/default -> vaulted passphrases
# Prerequisites:
#   - SSH key authentication works
#   - Vault files encrypted and decryptable
#   - vault_os_become_password is defined per-host (host_vars/<host>/vault.yml)
#   - initial password is either per-host vault_os_become_initial_password OR global vault_default_password
# Notes:
#   - This rotates the account defined by ansible_user by default
#   - Override per-host with: vault_os_rotate_user
# ============================================

- name: Password Rotation - Pre-Flight Checks
  hosts: all
  gather_facts: false
  become: false

  tasks:
    - name: Display rotation header
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘       PASSWORD ROTATION - PRE-FLIGHT     â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "âš ï¸  WARNING: This will change passwords on target hosts!"
          - ""
          - "Targets: {{ groups['all'] | join(', ') }}"
          - ""

    - name: Verify vault password file exists
      ansible.builtin.stat:
        path: "{{ lookup('env', 'HOME') }}/.vault_pass"
      register: vault_file
      delegate_to: localhost
      run_once: true

    - name: Fail if vault password file missing
      ansible.builtin.fail:
        msg: "Vault password file not found at ~/.vault_pass"
      when: not vault_file.stat.exists
      delegate_to: localhost
      run_once: true

    - name: Pause for confirmation
      ansible.builtin.pause:
        prompt: |
          âš ï¸  COMPETITION SAFETY GATE
          This will rotate OS passwords on ALL Linux hosts.
          Press ENTER to continue, or Ctrl+C to abort.
      when: (confirm | default('no') | lower) != 'yes'

# ------------------------------------------------------------
# 1) VERIFY CURRENT ACCESS USING INITIAL PASSWORD
# ------------------------------------------------------------

- name: Password Rotation - Verify current sudo access (initial password)
  hosts: all
  gather_facts: false
  ignore_unreachable: true

  pre_tasks:
    - name: Load vault variables (best effort)
      ansible.builtin.include_vars:
        file: "{{ item }}"
      loop:
        - "{{ playbook_dir }}/../group_vars/all/vault.yml"
        - "{{ playbook_dir }}/../host_vars/{{ inventory_hostname }}/vault.yml"
      failed_when: false
      no_log: true

    - name: Resolve effective initial become password
      ansible.builtin.set_fact:
        effective_initial_become_password: >-
          {{ vault_os_become_initial_password
             | default(vault_default_password
             | default('')) }}
      no_log: true

    - name: Ensure initial become password exists
      ansible.builtin.assert:
        that:
          - effective_initial_become_password | length > 0
        fail_msg: >-
          Missing initial become password for {{ inventory_hostname }}.
          Expected vault_os_become_initial_password or vault_default_password.
      no_log: true

    - name: Use initial become password
      ansible.builtin.set_fact:
        ansible_become_password: "{{ effective_initial_become_password }}"
      no_log: true

  tasks:
    - name: Verify SSH availability
      ansible.builtin.ping:
      register: ping_test

    - name: Verify sudo works (initial password)
      ansible.builtin.command: whoami
      become: true
      changed_when: false
      register: sudo_test
      failed_when: false
      when: ping_test is success

    - name: Display host status
      ansible.builtin.debug:
        msg:
          - "Host: {{ inventory_hostname }}"
          - "SSH: {{ 'âœ… Connected' if ping_test is success else 'âŒ Failed' }}"
          - "Sudo (initial pass): {{ 'âœ… Working' if (sudo_test.stdout | default('')) == 'root' else 'âŒ Failed' }}"
      when: ping_test is success or ping_test is failed

# ------------------------------------------------------------
# 2) ROTATE PASSWORDS
# ------------------------------------------------------------

- name: Password Rotation - Change Passwords
  hosts: all
  gather_facts: false
  ignore_unreachable: true

  pre_tasks:
    - name: Load vault variables (best effort)
      ansible.builtin.include_vars:
        file: "{{ item }}"
      loop:
        - "{{ playbook_dir }}/../group_vars/all/vault.yml"
        - "{{ playbook_dir }}/../host_vars/{{ inventory_hostname }}/vault.yml"
      failed_when: false
      no_log: true

    - name: Resolve effective initial + new become passwords
      ansible.builtin.set_fact:
        effective_initial_become_password: >-
          {{ vault_os_become_initial_password
             | default(vault_default_password
             | default('')) }}
        effective_new_become_password: "{{ vault_os_become_password | default('') }}"
      no_log: true

    - name: Ensure new password is defined (refuse to rotate if missing)
      ansible.builtin.assert:
        that:
          - effective_new_become_password | length > 0
        fail_msg: >-
          Missing NEW password for {{ inventory_hostname }}.
          Expected vault_os_become_password (host_vars/<host>/vault.yml).
          Refusing to rotate to an empty/unknown value.
      no_log: true

    - name: Use initial become password to perform rotation
      ansible.builtin.set_fact:
        ansible_become_password: "{{ effective_initial_become_password }}"
      no_log: true

    - name: "Determine which user to rotate (default: ansible_user)"
      ansible.builtin.set_fact:
        rotate_user: "{{ vault_os_rotate_user | default(ansible_user) }}"
      changed_when: false

  tasks:
    - name: Display password change plan
      ansible.builtin.debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "Host: {{ inventory_hostname }}"
          - "Rotate user: {{ rotate_user }}"
          - "Action: Set password to vaulted passphrase"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: Change user password
      ansible.builtin.user:
        name: "{{ rotate_user }}"
        password: "{{ effective_new_become_password | password_hash('sha512') }}"
        update_password: always
      become: true
      register: password_change
      no_log: true

    - name: Mark password as changed
      ansible.builtin.set_fact:
        password_rotated: true
      when: password_change is success

    - name: Display change result
      ansible.builtin.debug:
        msg: "âœ… Password changed successfully for {{ rotate_user }}@{{ inventory_hostname }}"
      when: password_change is success

    - name: Display change failure
      ansible.builtin.debug:
        msg: "âŒ Password change failed for {{ rotate_user }}@{{ inventory_hostname }}"
      when: password_change is failed

# ------------------------------------------------------------
# 3) VERIFY NEW PASSWORDS
# ------------------------------------------------------------

- name: Password Rotation - Verify new sudo access (new password)
  hosts: all
  gather_facts: false
  ignore_unreachable: true

  pre_tasks:
    - name: Load vault variables (best effort)
      ansible.builtin.include_vars:
        file: "{{ item }}"
      loop:
        - "{{ playbook_dir }}/../group_vars/all/vault.yml"
        - "{{ playbook_dir }}/../host_vars/{{ inventory_hostname }}/vault.yml"
      failed_when: false
      no_log: true

    - name: Resolve effective new become password
      ansible.builtin.set_fact:
        effective_new_become_password: "{{ vault_os_become_password | default('') }}"
      no_log: true

    - name: Ensure new password exists before validation
      ansible.builtin.assert:
        that:
          - effective_new_become_password | length > 0
        fail_msg: >-
          Missing NEW password for {{ inventory_hostname }} during validation.
          Expected vault_os_become_password.
      no_log: true

    - name: Use new become password
      ansible.builtin.set_fact:
        ansible_become_password: "{{ effective_new_become_password }}"
      no_log: true

  tasks:
    - name: Verify sudo with new password
      ansible.builtin.command: whoami
      become: true
      changed_when: false
      register: new_sudo_test
      failed_when: false

    - name: Mark validation as successful
      ansible.builtin.set_fact:
        password_validated: true
      when: new_sudo_test is success and new_sudo_test.stdout == "root"

    - name: Display validation result
      ansible.builtin.debug:
        msg: "{{ 'âœ… New password confirmed on ' ~ inventory_hostname if password_validated is defined else 'âŒ Credential check failed on ' ~ inventory_hostname }}"

# ------------------------------------------------------------
# 4) SUMMARY
# ------------------------------------------------------------

- name: Password Rotation - Summary
  hosts: localhost
  gather_facts: false
  become: false

  vars:
    rotated_hosts: "{{ groups['all'] | map('extract', hostvars) | selectattr('password_rotated', 'defined') | map(attribute='inventory_hostname') | list }}"
    validated_hosts: "{{ groups['all'] | map('extract', hostvars) | selectattr('password_validated', 'defined') | map(attribute='inventory_hostname') | list }}"
    failed_hosts: "{{ groups['all'] | difference(validated_hosts) }}"

  tasks:
    - name: Calculate metrics
      ansible.builtin.set_fact:
        total_hosts: "{{ groups['all'] | length }}"
        success_count: "{{ validated_hosts | length }}"
        failure_count: "{{ failed_hosts | length }}"
        success_rate: "{{ ((validated_hosts | length / (groups['all'] | length | default(1))) * 100) | round(1) }}"

    - name: Display final summary
      ansible.builtin.debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘         PASSWORD ROTATION COMPLETE       â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "Total hosts: {{ total_hosts }}"
          - "âœ… Successful: {{ success_count }}"
          - "âŒ Failed: {{ failure_count }}"
          - "Success rate: {{ success_rate }}%"
          - ""
          - "Successful hosts: {{ validated_hosts | join(', ') if validated_hosts else 'None' }}"
          - "{{ 'Failed hosts: ' ~ (failed_hosts | join(', ')) if failed_hosts else '' }}"
          - ""
          - "{{ 'âš ï¸ IMPORTANT: Continue using vault_os_become_password for competition.' if success_count | int > 0 else '' }}"

    - name: Send Discord notification (best effort)
      ansible.builtin.uri:
        url: "{{ vault_discord_webhook_url }}"
        method: POST
        body_format: json
        body:
          content: |
            ğŸ” **Password Rotation Complete**

            **Results:**
            â€¢ Total: {{ total_hosts }}
            â€¢ âœ… Success: {{ success_count }}
            â€¢ âŒ Failed: {{ failure_count }}
            â€¢ Rate: {{ success_rate }}%

            **Successful:** {{ validated_hosts | join(', ') if validated_hosts else 'None' }}
            {{ '**Failed:** ' ~ (failed_hosts | join(', ')) if failed_hosts else '' }}
        status_code: [200, 204]
      register: discord_result
      failed_when: false
      when:
        - vault_discord_webhook_url is defined
        - vault_discord_webhook_url != ""
        - "'YOUR_WEBHOOK' not in vault_discord_webhook_url"
      no_log: true

    - name: Fail if all hosts failed
      ansible.builtin.fail:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘   CRITICAL: ALL HOSTS FAILED             â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          All password rotations failed!

          Troubleshooting:
          1. Revert to a prior local preparation snapshot
          2. Verify vault files: ansible-vault view host_vars/*/vault.yml
          3. Confirm variables: ansible all -m debug -a "var=vault_os_become_password"
      when: success_count | int == 0
