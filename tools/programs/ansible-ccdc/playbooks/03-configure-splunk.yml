---
# Configure Splunk server (receiver + base configuration)
- name: Configure Splunk server
  hosts: monitoring
  become: true
  gather_facts: false

  pre_tasks:
    - name: Load host vault (required)
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../host_vars/{{ inventory_hostname }}/vault.yml"
      register: host_vault_loaded
      no_log: true
      become: false
      tags: [always]

    - name: Assert host vault loaded
      ansible.builtin.assert:
        that:
          - host_vault_loaded is succeeded
        fail_msg: "Host vault could not be loaded for {{ inventory_hostname }} (host_vars/{{ inventory_hostname }}/vault.yml)."
      become: false
      tags: [always]

    # Compute then pin (two tasks avoids same-task self-reference pitfalls)
    - name: Compute become password for this host
      ansible.builtin.set_fact:
        _become_pw: "{{ vault_os_become_password | default(vault_os_become_initial_password) }}"
      no_log: true
      become: false
      tags: [always]

    - name: Pin become password for this host
      ansible.builtin.set_fact:
        ansible_become_password: "{{ _become_pw }}"
        ansible_become_pass: "{{ _become_pw }}"
      no_log: true
      become: false
      tags: [always]

  roles:
    - role: splunk_configure
      tags: ["splunk_configure"]
    - role: splunk_content
      tags: ["splunk_content"]
    - role: splunk_harden
      tags: ["splunk_harden"]
